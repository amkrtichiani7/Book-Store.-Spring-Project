<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout :: layout(~{::section})}">
<body>
<section>
    <div class="container">
        <h2 th:text="#{nav.placeOrder}">Create New Order</h2>

        <form th:action="@{/orders/new}" th:object="${order}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="clientEmail" th:value="${#authentication.name}" />

            <div th:if="${#fields.hasAnyErrors()}"
                 style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
                <p><strong>Please correct the following errors:</strong></p>
                <ul>
                    <li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
                </ul>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold;">Logged in as:</label>
                <p style="padding: 10px; background: #f4f4f4; border-radius: 4px; border-left: 4px solid #3498db; margin: 5px 0;">
                    <span sec:authentication="name">User Email</span>
                </p>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold;">Assign to Employee:</label>
                <select th:field="*{employeeEmail}" class="form-control" style="width: 100%; padding: 8px;" required>
                    <option value="" disabled selected>Choose an employee to handle your order...</option>
                    <option th:each="emp : ${employees}"
                            th:value="${emp.email}"
                            th:text="${emp.name} + ' (' + ${emp.email} + ')'">
                    </option>
                </select>
            </div>

            <hr/>
            <h3>Books Selection</h3>
            <div id="book-items-container">
                <div th:each="item, stat : *{bookItems}" class="book-item-row" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">

                    <select th:field="*{bookItems[__${stat.index}__].bookName}" class="form-control" style="flex: 2; padding: 8px;" required>
                        <option value="" disabled selected>Select a book...</option>
                        <option th:each="b : ${allBooks}" th:value="${b.name}" th:text="${b.name} + ' ($' + ${b.price} + ')'"></option>
                    </select>

                    <div style="display: flex; align-items: center; gap: 5px;">
                        <label>Qty:</label>
                        <input type="number" th:field="*{bookItems[__${stat.index}__].quantity}"
                               min="1" style="width: 70px; padding: 8px;" class="form-control" required/>
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <button type="button" class="btn-secondary" onclick="addItem()">+ Add Another Book</button>
                <button type="submit" class="btn" style="background: #27ae60; color: white; padding: 10px 25px; border: none; font-weight: bold; cursor: pointer;">
                    Complete Purchase
                </button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        function addItem() {
            const container = document.getElementById('book-items-container');
            const rows = container.getElementsByClassName('book-item-row');
            const nextIndex = rows.length;

            // Clone the first row
            const newRow = rows[0].cloneNode(true);

            // Update indices in name and id attributes for Spring Binding
            const inputs = newRow.querySelectorAll('select, input');
            inputs.forEach(input => {
                // Update names: bookItems[0].xxx -> bookItems[1].xxx
                if(input.name) input.name = input.name.replace(/\[\d+\]/, `[${nextIndex}]`);
                if(input.id) input.id = input.id.replace(/_\d+__/, `_${nextIndex}__`);

                // Reset values
                if (input.tagName === 'INPUT') {
                    input.value = '1';
                } else {
                    input.selectedIndex = 0;
                }
            });
            container.appendChild(newRow);
        }
    </script>
</section>
</body>
</html>